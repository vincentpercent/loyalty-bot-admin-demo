{% extends "base.html" %}

{% block title %}Dashboard · Loyalty Demo Admin{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Контейнер для контента с overlay синхронизации -->
    <div class="relative" id="dashboard-content">
        <!-- Overlay для синхронизации -->
        <div id="sync-overlay" class="hidden absolute inset-0 bg-royal-black/80 backdrop-blur-sm z-50 flex items-center justify-center rounded-2xl">
            <div class="text-center w-full max-w-md px-6">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-royal-gold border-t-transparent mb-4"></div>
                <p class="text-sm text-royal-gold font-medium mb-4">Синхронизация балансов...</p>
                
                <!-- Прогресс-бар -->
                <div class="relative w-full h-3 bg-royal-border/30 rounded-full overflow-hidden mb-2">
                    <div id="progress-bar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-royal-gold via-amber-500 to-royal-gold rounded-full transition-all duration-300 ease-out" style="width: 0%">
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shimmer"></div>
                    </div>
                </div>
                
                <!-- Текст прогресса -->
                <p class="text-xs text-royal-muted" id="sync-progress">Подключение к YClients</p>
                <p class="text-xs text-royal-gold/70 mt-1" id="sync-stats">0 / 0</p>
            </div>
        </div>

    <!-- Заголовок -->
    <div class="relative overflow-hidden bg-gradient-to-br from-royal-surface via-royal-surface to-royal-gold/5 rounded-2xl border border-royal-border p-6">
        <div class="absolute top-0 right-0 w-72 h-72 bg-gradient-to-bl from-royal-gold/10 to-transparent rounded-full -mr-36 -mt-36"></div>
        <div class="absolute bottom-0 left-0 w-56 h-56 bg-gradient-to-tr from-emerald-500/5 to-transparent rounded-full -ml-28 -mb-28"></div>
        
        <div class="relative flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-royal-gold/30 to-royal-gold/10 border border-royal-gold/40 flex items-center justify-center">
                        <svg class="w-5 h-5 text-royal-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="text-[10px] uppercase tracking-[0.22em] text-royal-gold font-medium">
                            Панель управления
                        </div>
                        <h1 class="text-xl font-bold">Loyalty Demo</h1>
                    </div>
                </div>
                <p class="text-sm text-royal-muted mt-2 max-w-md">
                    Период: <span class="text-royal-gold font-medium">{{ period }} дней</span>
                    <select 
                        onchange="window.location.href='/?period=' + this.value"
                        class="ml-2 bg-royal-border/50 border border-royal-border rounded-lg px-2 py-0.5 text-xs text-royal-gold focus:outline-none focus:border-royal-gold cursor-pointer"
                    >
                        <option value="7" {% if period == 7 %}selected{% endif %}>7 дней</option>
                        <option value="14" {% if period == 14 %}selected{% endif %}>14 дней</option>
                        <option value="30" {% if period == 30 %}selected{% endif %}>30 дней</option>
                        <option value="90" {% if period == 90 %}selected{% endif %}>90 дней</option>
                    </select>
                </p>
            </div>
            <div class="flex flex-wrap gap-2">
                <a href="{{ url_for('users_broadcast_page') }}"
                   class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-gradient-to-r from-royal-gold to-amber-500 text-black text-xs font-semibold hover:shadow-lg hover:shadow-royal-gold/20 transition-all">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
                    </svg>
                    Объявление
                </a>
                <a href="{{ url_for('users_bulk_bonus_page') }}"
                   class="flex items-center gap-2 px-4 py-2.5 rounded-xl border border-royal-gold text-royal-gold text-xs hover:bg-royal-gold hover:text-black transition-all">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Начисление
                </a>
            </div>
        </div>
    </div>

    <!-- Записи через бота -->
    <section>
        <div class="flex items-center gap-3 mb-4">
            <div class="w-1 h-4 rounded-full bg-blue-500"></div>
            <div class="text-[10px] uppercase tracking-[0.22em] text-royal-muted">
                Записи через бота
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Создано -->
            <div class="group relative overflow-hidden bg-gradient-to-br from-blue-500/10 via-royal-surface to-royal-surface rounded-2xl border border-blue-500/20 hover:border-blue-400/40 transition-all duration-300 p-5">
                <div class="absolute top-0 right-0 w-20 h-20 bg-blue-500/10 rounded-full -mr-10 -mt-10 group-hover:scale-150 transition-transform duration-500"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[10px] uppercase tracking-wider text-blue-400/70">Создано</span>
                        <svg class="w-5 h-5 text-blue-400/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4"/>
                        </svg>
                    </div>
                    <div class="text-3xl font-bold text-blue-400">{{ bookings_created }}</div>
                    <div class="text-xs text-royal-muted mt-1">записей за период</div>
                </div>
            </div>

            <!-- Выполнено -->
            <div class="group relative overflow-hidden bg-gradient-to-br from-emerald-500/10 via-royal-surface to-royal-surface rounded-2xl border border-emerald-500/20 hover:border-emerald-400/40 transition-all duration-300 p-5">
                <div class="absolute top-0 right-0 w-20 h-20 bg-emerald-500/10 rounded-full -mr-10 -mt-10 group-hover:scale-150 transition-transform duration-500"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[10px] uppercase tracking-wider text-emerald-400/70">Выполнено</span>
                        <svg class="w-5 h-5 text-emerald-400/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                    <div class="text-3xl font-bold text-emerald-400">{{ bookings_completed }}</div>
                    <div class="text-xs text-royal-muted mt-1">завершённых визитов</div>
                </div>
            </div>

            <!-- Отменено -->
            <div class="group relative overflow-hidden bg-gradient-to-br from-red-500/10 via-royal-surface to-royal-surface rounded-2xl border border-red-500/20 hover:border-red-400/40 transition-all duration-300 p-5">
                <div class="absolute top-0 right-0 w-20 h-20 bg-red-500/10 rounded-full -mr-10 -mt-10 group-hover:scale-150 transition-transform duration-500"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[10px] uppercase tracking-wider text-red-400/70">Отменено</span>
                        <svg class="w-5 h-5 text-red-400/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </div>
                    <div class="text-3xl font-bold text-red-400">{{ bookings_cancelled }}</div>
                    <div class="text-xs text-royal-muted mt-1">отменённых записей</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Бонусная программа -->
    <section>
        <div class="flex items-center gap-3 mb-4">
            <div class="w-1 h-4 rounded-full bg-royal-gold"></div>
            <div class="text-[10px] uppercase tracking-[0.22em] text-royal-muted">
                Бонусы · за {{ period }} дней
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Начислено -->
            <div class="group relative overflow-hidden bg-gradient-to-br from-emerald-500/10 via-royal-surface to-royal-surface rounded-2xl border border-emerald-500/20 hover:border-emerald-400/40 transition-all duration-300 p-5">
                <div class="absolute top-0 right-0 w-20 h-20 bg-emerald-500/10 rounded-full -mr-10 -mt-10 group-hover:scale-150 transition-transform duration-500"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[10px] uppercase tracking-wider text-emerald-400/70">Начислено</span>
                        <svg class="w-5 h-5 text-emerald-400/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                        </svg>
                    </div>
                    <div class="text-3xl font-bold text-emerald-400">+{{ bonus_accrued }}₽</div>
                    <div class="text-xs text-royal-muted mt-1">бонусных рублей</div>
                </div>
            </div>

            <!-- Списано -->
            <div class="group relative overflow-hidden bg-gradient-to-br from-red-500/10 via-royal-surface to-royal-surface rounded-2xl border border-red-500/20 hover:border-red-400/40 transition-all duration-300 p-5">
                <div class="absolute top-0 right-0 w-20 h-20 bg-red-500/10 rounded-full -mr-10 -mt-10 group-hover:scale-150 transition-transform duration-500"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[10px] uppercase tracking-wider text-red-400/70">Списано</span>
                        <svg class="w-5 h-5 text-red-400/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>
                        </svg>
                    </div>
                    <div class="text-3xl font-bold text-red-400">−{{ bonus_spent }}₽</div>
                    <div class="text-xs text-royal-muted mt-1">использовано клиентами</div>
                </div>
            </div>

            <!-- Обязательства -->
            <div class="group relative overflow-hidden bg-gradient-to-br from-royal-gold/15 via-royal-surface to-royal-surface rounded-2xl border border-royal-gold/40 hover:border-royal-gold/60 transition-all duration-300 p-5 shadow-lg shadow-royal-gold/5">
                <div class="absolute top-0 right-0 w-20 h-20 bg-royal-gold/10 rounded-full -mr-10 -mt-10 group-hover:scale-150 transition-transform duration-500"></div>
                <div class="relative">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[10px] uppercase tracking-wider text-royal-gold">Обязательства</span>
                        <svg class="w-5 h-5 text-royal-gold/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div class="text-3xl font-bold text-white">{{ total_bonus }}₽</div>
                    <div class="text-xs text-royal-muted mt-1">несписанные бонусы</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Выполненные задания -->
    <section>
        <div class="flex items-center gap-3 mb-4">
            <div class="w-1 h-4 rounded-full bg-purple-500"></div>
            <div class="text-[10px] uppercase tracking-[0.22em] text-royal-muted">
                Выполненные задания · за {{ period }} дней
            </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- Welcome bonus -->
            <div class="group relative overflow-hidden bg-gradient-to-br from-pink-500/10 via-royal-surface to-royal-surface rounded-2xl border border-pink-500/20 hover:border-pink-400/40 transition-all duration-300 p-4">
                <div class="absolute inset-0 bg-gradient-to-t from-pink-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <div class="relative flex items-center justify-between">
                    <div>
                        <div class="text-2xl font-bold text-pink-400">{{ tasks_welcome }}</div>
                        <div class="text-[10px] text-royal-muted mt-1 uppercase tracking-wider">Welcome</div>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-pink-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-pink-400/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Подписка на канал -->
            <div class="group relative overflow-hidden bg-gradient-to-br from-cyan-500/10 via-royal-surface to-royal-surface rounded-2xl border border-cyan-500/20 hover:border-cyan-400/40 transition-all duration-300 p-4">
                <div class="absolute inset-0 bg-gradient-to-t from-cyan-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <div class="relative flex items-center justify-between">
                    <div>
                        <div class="text-2xl font-bold text-cyan-400">{{ tasks_channel }}</div>
                        <div class="text-[10px] text-royal-muted mt-1 uppercase tracking-wider">Подписка</div>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-cyan-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-cyan-400/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Отзывы -->
            <div class="group relative overflow-hidden bg-gradient-to-br from-amber-500/10 via-royal-surface to-royal-surface rounded-2xl border border-amber-500/20 hover:border-amber-400/40 transition-all duration-300 p-4">
                <div class="absolute inset-0 bg-gradient-to-t from-amber-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <div class="relative flex items-center justify-between">
                    <div>
                        <div class="text-2xl font-bold text-amber-400">{{ tasks_review }}</div>
                        <div class="text-[10px] text-royal-muted mt-1 uppercase tracking-wider">Отзывы</div>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-amber-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-amber-400/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Рефералы -->
            <div class="group relative overflow-hidden bg-gradient-to-br from-violet-500/10 via-royal-surface to-royal-surface rounded-2xl border border-violet-500/20 hover:border-violet-400/40 transition-all duration-300 p-4">
                <div class="absolute inset-0 bg-gradient-to-t from-violet-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <div class="relative flex items-center justify-between">
                    <div>
                        <div class="text-2xl font-bold text-violet-400">{{ tasks_referral }}</div>
                        <div class="text-[10px] text-royal-muted mt-1 uppercase tracking-wider">Рефералы</div>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-violet-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-violet-400/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Пользователи -->
    <section>
        <div class="flex items-center gap-3 mb-4">
            <div class="w-1 h-4 rounded-full bg-indigo-500"></div>
            <div class="text-[10px] uppercase tracking-[0.22em] text-royal-muted">
                Пользователи
            </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- Всего -->
            <div class="relative overflow-hidden bg-royal-surface rounded-2xl border border-royal-border hover:border-indigo-400/40 transition-all p-5">
                <div class="absolute top-0 right-0 w-16 h-16 bg-indigo-500/10 rounded-full -mr-8 -mt-8"></div>
                <div class="relative">
                    <div class="text-[10px] uppercase tracking-wider text-indigo-400/70 mb-2">Всего</div>
                    <div class="text-3xl font-bold text-white">{{ total_users }}</div>
                    <div class="text-xs text-royal-muted mt-1">пользователей</div>
                </div>
            </div>

            <!-- Новые за 7 дней -->
            <div class="relative overflow-hidden bg-royal-surface rounded-2xl border border-royal-border hover:border-emerald-400/40 transition-all p-5">
                <div class="absolute top-0 right-0 w-16 h-16 bg-emerald-500/10 rounded-full -mr-8 -mt-8"></div>
                <div class="relative">
                    <div class="text-[10px] uppercase tracking-wider text-emerald-400/70 mb-2">За 7 дней</div>
                    <div class="text-3xl font-bold text-emerald-400">+{{ new_last_week }}</div>
                    <div class="text-xs text-royal-muted mt-1">новых</div>
                </div>
            </div>

            <!-- Новые за 30 дней -->
            <div class="relative overflow-hidden bg-royal-surface rounded-2xl border border-royal-border hover:border-blue-400/40 transition-all p-5">
                <div class="absolute top-0 right-0 w-16 h-16 bg-blue-500/10 rounded-full -mr-8 -mt-8"></div>
                <div class="relative">
                    <div class="text-[10px] uppercase tracking-wider text-blue-400/70 mb-2">За 30 дней</div>
                    <div class="text-3xl font-bold text-blue-400">+{{ new_last_month }}</div>
                    <div class="text-xs text-royal-muted mt-1">новых</div>
                </div>
            </div>

            <!-- Welcome rate -->
            <div class="relative overflow-hidden bg-royal-surface rounded-2xl border border-royal-border hover:border-royal-gold/40 transition-all p-5">
                <div class="absolute top-0 right-0 w-16 h-16 bg-royal-gold/10 rounded-full -mr-8 -mt-8"></div>
                <div class="relative">
                    <div class="text-[10px] uppercase tracking-wider text-royal-gold/70 mb-2">Welcome rate</div>
                    <div class="text-3xl font-bold text-royal-gold">
                        {% if total_users > 0 %}{{ ((tasks_welcome / total_users) * 100) | round(1) }}%{% else %}0%{% endif %}
                    </div>
                    <div class="text-xs text-royal-muted mt-1">активировали</div>
                </div>
            </div>
        </div>
    </section>

    <!-- График активности + Топ рефоводов -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- График активности -->
        <div class="lg:col-span-2 relative overflow-hidden bg-royal-surface rounded-2xl border border-royal-border">
            <div class="absolute inset-0 bg-gradient-to-br from-royal-gold/5 via-transparent to-blue-500/5"></div>
            <div class="relative p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-1 h-8 rounded-full bg-royal-gold"></div>
                        <div>
                            <div class="text-[10px] uppercase tracking-[0.22em] text-royal-muted">
                                Активность
                            </div>
                            <div class="text-xs text-royal-muted/60">Регистрации за 14 дней</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 bg-royal-border/30 rounded-lg p-1">
                        <button id="dashChartPrev" class="w-7 h-7 flex items-center justify-center rounded-md hover:bg-royal-gold/20 text-royal-muted hover:text-royal-gold transition text-sm">‹</button>
                        <span id="dashChartTypeLabel" class="text-[10px] text-royal-gold uppercase tracking-wider min-w-[60px] text-center font-medium">Области</span>
                        <button id="dashChartNext" class="w-7 h-7 flex items-center justify-center rounded-md hover:bg-royal-gold/20 text-royal-muted hover:text-royal-gold transition text-sm">›</button>
                    </div>
                </div>
                <div class="h-64">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Топ рефоводов -->
        <div class="relative overflow-hidden bg-royal-surface rounded-2xl border border-royal-border">
            <div class="absolute inset-0 bg-gradient-to-br from-violet-500/5 via-transparent to-pink-500/5"></div>
            <div class="relative p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-1 h-8 rounded-full bg-violet-500"></div>
                    <div class="text-[10px] uppercase tracking-[0.22em] text-royal-muted">
                        Топ рефоводов
                    </div>
                </div>
                {% if top_referrers %}
                    <ul class="space-y-3">
                        {% for user, earned in top_referrers %}
                            <li class="flex items-center justify-between p-3 rounded-xl bg-royal-border/20 hover:bg-royal-border/40 transition-all group">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-violet-500/30 to-pink-500/30 flex items-center justify-center text-xs font-bold">
                                        {{ loop.index }}
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium group-hover:text-royal-gold transition-colors">
                                            {{ user.full_name or user.username or ("TG:" ~ user.telegram_id) }}
                                        </div>
                                        <div class="text-[10px] text-royal-muted">ID {{ user.id }}</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-bold text-emerald-400">+{{ earned }}₽</div>
                                    <a href="{{ url_for('user_detail', user_id=user.id) }}"
                                       class="text-[10px] text-royal-gold opacity-0 group-hover:opacity-100 transition-opacity">
                                        Открыть →
                                    </a>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-center py-8">
                        <svg class="w-12 h-12 mx-auto text-royal-muted/30 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        <p class="text-sm text-royal-muted">Пока нет реферальной активности</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- Быстрые ссылки -->
    <section class="flex flex-wrap gap-3">
        <a href="{{ url_for('analytics') }}"
           class="group flex items-center gap-3 px-5 py-3 rounded-xl bg-royal-surface border border-royal-border hover:border-royal-gold text-royal-muted hover:text-royal-gold transition-all">
            <svg class="w-4 h-4 opacity-50 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <span class="text-xs uppercase tracking-wider">Аналитика бонусов</span>
        </a>
        <a href="{{ url_for('bookings_analytics') }}"
           class="group flex items-center gap-3 px-5 py-3 rounded-xl bg-royal-surface border border-royal-border hover:border-royal-gold text-royal-muted hover:text-royal-gold transition-all">
            <svg class="w-4 h-4 opacity-50 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
            </svg>
            <span class="text-xs uppercase tracking-wider">Аналитика записей</span>
        </a>
        <a href="{{ url_for('bookings_list') }}"
           class="group flex items-center gap-3 px-5 py-3 rounded-xl bg-royal-surface border border-royal-border hover:border-royal-gold text-royal-muted hover:text-royal-gold transition-all">
            <svg class="w-4 h-4 opacity-50 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <span class="text-xs uppercase tracking-wider">Записи YClients</span>
        </a>
    </section>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function () {
    const labels = {{ activity_labels | tojson }};
    const values = {{ activity_values | tojson }};

    const canvas = document.getElementById('activityChart');
    const prevBtn = document.getElementById('dashChartPrev');
    const nextBtn = document.getElementById('dashChartNext');
    const typeLabel = document.getElementById('dashChartTypeLabel');

    if (!canvas || !labels.length) return;

    const ctx = canvas.getContext('2d');

    // Градиент для заливки
    const gradient = ctx.createLinearGradient(0, 0, 0, 256);
    gradient.addColorStop(0, 'rgba(212, 175, 55, 0.35)');
    gradient.addColorStop(1, 'rgba(212, 175, 55, 0.02)');

    const chartTypes = [
        { type: 'line', fill: true, label: 'Области' },
        { type: 'line', fill: false, label: 'Линии' },
        { type: 'bar', fill: false, label: 'Столбцы' }
    ];
    let currentTypeIndex = 0;

    const baseOptions = {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 500, easing: 'easeOutQuart' },
        interaction: { intersect: false, mode: 'index' },
        plugins: {
            legend: { display: false },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.9)',
                titleColor: '#D4AF37',
                bodyColor: '#fff',
                borderColor: '#D4AF37',
                borderWidth: 1,
                cornerRadius: 8,
                padding: 12,
                displayColors: false,
                callbacks: {
                    title: (items) => items[0]?.label || '',
                    label: (item) => `Регистраций: ${item.raw}`
                }
            }
        },
        scales: {
            x: {
                ticks: { color: '#6B7280', font: { size: 10 }, maxRotation: 0 },
                grid: { display: false },
                border: { color: '#262626' }
            },
            y: {
                beginAtZero: true,
                ticks: { color: '#6B7280', font: { size: 10 }, stepSize: 1, precision: 0 },
                grid: { color: 'rgba(38,38,38,0.5)', drawBorder: false },
                border: { display: false }
            }
        }
    };

    function buildDataset(ct) {
        return {
            label: 'Регистрации',
            data: values,
            tension: 0.4,
            borderWidth: ct.type === 'bar' ? 0 : 3,
            borderColor: '#D4AF37',
            backgroundColor: ct.fill ? gradient : (ct.type === 'bar' ? 'rgba(212, 175, 55, 0.75)' : '#D4AF37'),
            fill: ct.fill,
            pointRadius: ct.type === 'bar' ? 0 : 5,
            pointBackgroundColor: '#D4AF37',
            pointBorderColor: '#1a1a1a',
            pointBorderWidth: 2,
            pointHoverRadius: 7,
            pointHoverBackgroundColor: '#D4AF37',
            pointHoverBorderColor: '#fff',
            borderRadius: ct.type === 'bar' ? 6 : 0
        };
    }

    let chart = new Chart(ctx, {
        type: chartTypes[currentTypeIndex].type,
        data: { labels: labels, datasets: [buildDataset(chartTypes[currentTypeIndex])] },
        options: baseOptions
    });

    function updateChart(direction) {
        currentTypeIndex = (currentTypeIndex + direction + chartTypes.length) % chartTypes.length;
        const ct = chartTypes[currentTypeIndex];
        typeLabel.textContent = ct.label;

        chart.destroy();
        chart = new Chart(ctx, {
            type: ct.type,
            data: { labels: labels, datasets: [buildDataset(ct)] },
            options: baseOptions
        });
    }

    if (prevBtn) prevBtn.addEventListener('click', () => updateChart(-1));
    if (nextBtn) nextBtn.addEventListener('click', () => updateChart(1));

})();
</script>

<script>
(function() {
    // Проверяем параметр URL - если синхронизация уже была выполнена, не запускаем повторно
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('synced') === '1') {
        return;
    }
    
    // Проверяем, не идет ли уже синхронизация
    if (window.syncInProgress) {
        return;
    }
    
    const overlay = document.getElementById('sync-overlay');
    const content = document.getElementById('dashboard-content');
    const progressText = document.getElementById('sync-progress');
    const progressBar = document.getElementById('progress-bar');
    const syncStats = document.getElementById('sync-stats');
    
    if (!overlay || !content || !progressText || !progressBar || !syncStats) {
        return;
    }
    
    // Помечаем, что синхронизация началась
    window.syncInProgress = true;
    
    // Показываем overlay и затемняем контент
    overlay.classList.remove('hidden');
    content.style.opacity = '0.3';
    content.style.pointerEvents = 'none';
    
    // Сбрасываем прогресс
    progressBar.style.width = '0%';
    progressText.textContent = 'Начало синхронизации...';
    syncStats.textContent = '0 / 0';
    
    // Запускаем синхронизацию
    fetch('{{ url_for("sync_balances") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const synced = data.synced || 0;
            const total = data.total || 1;
            const percentage = Math.min(100, Math.round((synced / total) * 100));
            
            // Обновляем прогресс-бар
            progressBar.style.width = percentage + '%';
            progressText.textContent = `Синхронизировано: ${synced} из ${total} пользователей`;
            syncStats.textContent = `${synced} / ${total}`;
            
            setTimeout(() => {
                overlay.classList.add('hidden');
                content.style.opacity = '1';
                content.style.pointerEvents = 'auto';
                window.syncInProgress = false;
                
                // Обновляем страницу для отображения актуальных данных
                const url = new URL(window.location);
                url.searchParams.set('synced', '1');
                window.location.href = url.toString();
            }, 1500);
        } else {
            window.syncInProgress = false;
            progressText.textContent = 'Ошибка синхронизации';
            progressBar.style.width = '0%';
            setTimeout(() => {
                overlay.classList.add('hidden');
                content.style.opacity = '1';
                content.style.pointerEvents = 'auto';
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Ошибка синхронизации:', error);
        window.syncInProgress = false;
        progressText.textContent = 'Ошибка подключения';
        setTimeout(() => {
            overlay.classList.add('hidden');
            content.style.opacity = '1';
            content.style.pointerEvents = 'auto';
        }, 2000);
    });
})();
</script>
    </div>
{% endblock %}
